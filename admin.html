<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>ê´€ë¦¬ì: ê¸‰ì‹í‘œ ì—…ë¡œë“œ</title>
  <style>
    body { max-width:480px; margin:2em auto; font-family:sans-serif; }
    .field { margin-bottom:1em; }
    label { display:block; margin-bottom:.3em; font-weight:bold; }
    input[type="text"], input[type="password"] {
      width:100%; padding:.5em; box-sizing:border-box;
    }
    button { padding:.6em 1.2em; margin-right:.5em; }
    #preview img { max-width:100%; margin-top:1em; }
    #status { margin-top:1em; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h1>ğŸ« ê¸‰ì‹íŒ ê´€ë¦¬ì</h1>

  <div class="field">
    <label for="imKey">IMGBB API Key</label>
    <input type="password" id="imKey" placeholder="ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°">
    <button id="saveKeys">ì €ì¥</button>
    <button id="clearKeys">ì‚­ì œ</button>
    <small id="imKeyStatus"></small>
  </div>

  <div class="field">
    <label for="ghToken">GitHub Token (PAT)</label>
    <input type="password" id="ghToken" placeholder="ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°">
    <small id="ghTokenStatus"></small>
  </div>

  <div class="field">
    <label for="repoOwner">Repo Owner</label>
    <input type="text" id="repoOwner" placeholder="GitHub ì‚¬ìš©ìëª… ë˜ëŠ” ì¡°ì§ëª…">
  </div>

  <div class="field">
    <label for="repoName">Repo Name</label>
    <input type="text" id="repoName" placeholder="ì €ì¥ì†Œ ì´ë¦„">
  </div>

  <div class="field">
    <label for="filePath">Config íŒŒì¼ ê²½ë¡œ</label>
    <input type="text" id="filePath" value="config.json">
  </div>

  <hr>

  <div class="field">
    <label for="fileInput">ìƒˆ ê¸‰ì‹í‘œ ì´ë¯¸ì§€ ì„ íƒ</label>
    <!-- capture="environment" ì„ ì£¼ë©´ í›„ë©´ ì¹´ë©”ë¼, capture="user" ë©´ ì…€ì¹´ìš© ì¹´ë©”ë¼ í˜¸ì¶œ -->
    <input type="file" id="fileInput" accept="image/*" capture="environment">
  </div>

  <button id="doUpload">ì—…ë¡œë“œ ë° ë°˜ì˜</button>

  <div id="preview"></div>
  <div id="status"></div>

  <script>
    // â€”â€” ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í‚¤ ì´ë¦„ ì •ì˜ â€”â€” 
    const LS_KEYS = {
      IMGBB:   'admin.imgbbKey',
      GITHUB:  'admin.githubToken',
      OWNER:   'admin.repoOwner',
      NAME:    'admin.repoName',
      PATH:    'admin.filePath'
    };

    // â€”â€” ìš”ì†Œ ì°¸ì¡° â€”â€” 
    const imKeyIn    = document.getElementById('imKey');
    const ghTokenIn  = document.getElementById('ghToken');
    const ownerIn    = document.getElementById('repoOwner');
    const nameIn     = document.getElementById('repoName');
    const pathIn     = document.getElementById('filePath');
    const saveBtn    = document.getElementById('saveKeys');
    const clearBtn   = document.getElementById('clearKeys');
    const imStatus   = document.getElementById('imKeyStatus');
    const ghStatus   = document.getElementById('ghTokenStatus');
    const fileIn     = document.getElementById('fileInput');
    const uploadBtn  = document.getElementById('doUpload');
    const previewDiv = document.getElementById('preview');
    const statusDiv  = document.getElementById('status');

    // â€”â€” ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë¡œë“œ â€”â€” 
    function loadSettings() {
      const im = localStorage.getItem(LS_KEYS.IMGBB);
      const gh = localStorage.getItem(LS_KEYS.GITHUB);
      const ow = localStorage.getItem(LS_KEYS.OWNER);
      const nm = localStorage.getItem(LS_KEYS.NAME);
      const pt = localStorage.getItem(LS_KEYS.PATH);

      if (im) {
        imKeyIn.value = im;
        imStatus.textContent = 'ì €ì¥ë¨';
      }
      if (gh) {
        ghTokenIn.value = gh;
        ghStatus.textContent = 'ì €ì¥ë¨';
      }
      if (ow) ownerIn.value = ow;
      if (nm) nameIn.value = nm;
      if (pt) pathIn.value = pt;
    }

    // â€”â€” ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥ â€”â€” 
    saveBtn.onclick = () => {
      const im = imKeyIn.value.trim();
      const gh = ghTokenIn.value.trim();
      if (!im || !gh) {
        alert('ë‘ í‚¤ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      localStorage.setItem(LS_KEYS.IMGBB, im);
      localStorage.setItem(LS_KEYS.GITHUB, gh);
      localStorage.setItem(LS_KEYS.OWNER, ownerIn.value.trim());
      localStorage.setItem(LS_KEYS.NAME, nameIn.value.trim());
      localStorage.setItem(LS_KEYS.PATH, pathIn.value.trim());
      imStatus.textContent = 'ì €ì¥ë¨';
      ghStatus.textContent = 'ì €ì¥ë¨';
      alert('í‚¤ì™€ ì •ë³´ê°€ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    };

    // â€”â€” ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì‚­ì œ â€”â€” 
    clearBtn.onclick = () => {
      if (!confirm('ì •ë§ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      Object.values(LS_KEYS).forEach(k => localStorage.removeItem(k));
      imKeyIn.value = ghTokenIn.value = ownerIn.value = nameIn.value = '';
      pathIn.value = 'config.json';
      imStatus.textContent = ghStatus.textContent = '';
      alert('ë¡œì»¬ì— ì €ì¥ëœ í‚¤ ë° ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    };

    // â€”â€” ë©”íƒ€ë°ì´í„° ì œê±° í•¨ìˆ˜ (Canvas) â€”â€” 
    function stripMetadata(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => {
          const img = new Image();
          img.onload = () => {
            const c = document.createElement('canvas');
            c.width = img.width;
            c.height = img.height;
            c.getContext('2d').drawImage(img,0,0);
            c.toBlob(blob => {
              const r2 = new FileReader();
              r2.onload = () => resolve(r2.result.split(',')[1]);
              r2.onerror = reject;
              r2.readAsDataURL(blob);
            }, 'image/jpeg', 0.9);
          };
          img.onerror = reject;
          img.src = r.result;
        };
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    // â€”â€” imgbb ì—…ë¡œë“œ â€”â€” 
    async function uploadToImgbb(b64) {
      const key = localStorage.getItem(LS_KEYS.IMGBB);
      const form = new FormData();
      form.append('key', key);
      form.append('image', b64);
      const res = await fetch('https://api.imgbb.com/1/upload', {
        method: 'POST', body: form
      });
      const js = await res.json();
      if (!js.success) throw new Error('imgbb error: '+JSON.stringify(js));
      return js.data.url;
    }

    // â€”â€” GitHub config.json ì—…ë°ì´íŠ¸ â€”â€” 
    async function updateGitHubConfig(newUrl) {
      const token = localStorage.getItem(LS_KEYS.GITHUB);
      const owner = localStorage.getItem(LS_KEYS.OWNER);
      const repo  = localStorage.getItem(LS_KEYS.NAME);
      const path  = localStorage.getItem(LS_KEYS.PATH);

      // ê¸°ì¡´ SHA ê°€ì ¸ì˜¤ê¸°
      const getRes = await fetch(
        `https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
        headers: { Authorization: `token ${token}` }
      });
      if (!getRes.ok) throw new Error('GitHub GET error: '+getRes.status);
      const getJs = await getRes.json();
      const sha   = getJs.sha;

      // ìƒˆ config.json ë§Œë“¤ê¸°
      const newCfg = JSON.stringify({ imageUrl: newUrl }, null, 2);
      const content = btoa(unescape(encodeURIComponent(newCfg)));

      // PUT ìš”ì²­
      const putRes = await fetch(
        `https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: "Update menu image via admin UI",
          content: content,
          sha: sha
        })
      });
      if (!putRes.ok) {
        const err = await putRes.json();
        throw new Error('GitHub PUT error: '+JSON.stringify(err));
      }
      return putRes.json();
    }

    // â€”â€” ë©”ì¸ ì—…ë¡œë“œ íë¦„ â€”â€” 
    uploadBtn.onclick = async () => {
      const file = fileIn.files[0];
      if (!file) return alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      statusDiv.textContent = 'âŒ› ì²˜ë¦¬ì¤‘â€¦';
      previewDiv.innerHTML = statusDiv.textContent;

      try {
        // 1) ë©”íƒ€ë°ì´í„° ì œê±° ë° ë¯¸ë¦¬ë³´ê¸°
        const b64 = await stripMetadata(file);
        previewDiv.innerHTML = `<h3>ë¯¸ë¦¬ë³´ê¸°</h3>
                                <img src="data:image/jpeg;base64,${b64}">`;

        // 2) imgbb ì—…ë¡œë“œ
        statusDiv.textContent = 'ğŸ“¤ imgbb ì—…ë¡œë“œâ€¦';
        const url = await uploadToImgbb(b64);

        // 3) GitHub Pages ì—…ë°ì´íŠ¸
        statusDiv.textContent = 'ğŸ”„ GitHubì— ë°˜ì˜ ì¤‘â€¦';
        await updateGitHubConfig(url);

        statusDiv.innerHTML = `âœ… ì™„ë£Œ!<br>
          <a href="${url}" target="_blank">ìƒˆ ì´ë¯¸ì§€ í™•ì¸</a><br>
          <small>ì ì‹œ í›„ index.htmlì— ë°˜ì˜ë©ë‹ˆë‹¤.</small>`;
      } catch (e) {
        console.error(e);
        statusDiv.textContent = 'âŒ ì˜¤ë¥˜: ' + e.message;
      }
    };

    // â€”â€” ì´ˆê¸° ë¡œë“œ ì‹œ ì„¸íŒ… ë¶ˆëŸ¬ì˜¤ê¸° â€”â€” 
    window.addEventListener('DOMContentLoaded', loadSettings);
  </script>
</body>
</html>
