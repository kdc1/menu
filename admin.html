<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì â€“ ê¸‰ì‹ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { margin: 5px 0; width: 100%; }
    #status { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>ê¸‰ì‹ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h1>
  <label>GitHub Owner
    <input id="owner" type="text" placeholder="ì˜ˆ: your-username">
  </label>
  <label>Repository Name
    <input id="name" type="text" placeholder="ì˜ˆ: your-repo">
  </label>
  <label>GitHub Token
    <input id="github" type="password" placeholder="ghp_â€¦">
  </label>
  <label>ì €ì¥í•  ê²½ë¡œ (ê¸°ë³¸: menu.jpg)
    <input id="path" type="text" placeholder="menu.jpg" value="menu.jpg">
  </label>
  <label>ì—…ë¡œë“œí•  ì´ë¯¸ì§€ íŒŒì¼
    <input id="file" type="file" accept="image/*">
  </label>
  <button id="uploadBtn">ì—…ë¡œë“œ</button>

  <div id="status"></div>

  <script>
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
    const LS_KEYS = {
      OWNER:  'github_owner',
      NAME:   'github_repo',
      GITHUB: 'github_token'
    };

    // ì…ë ¥ê°’ ë³µì› ë° ë³€ê²½ ì‹œ ì €ì¥
    const ownerIn = document.getElementById('owner');
    const nameIn  = document.getElementById('name');
    const tokenIn = document.getElementById('github');
    const pathIn  = document.getElementById('path');
    [[LS_KEYS.OWNER, ownerIn],
     [LS_KEYS.NAME,  nameIn],
     [LS_KEYS.GITHUB, tokenIn]
    ].forEach(([key, el]) => {
      const v = localStorage.getItem(key);
      if (v) el.value = v;
      el.addEventListener('change', () => {
        localStorage.setItem(key, el.value.trim());
      });
    });

    const fileInput = document.getElementById('file');
    const uploadBtn = document.getElementById('uploadBtn');
    const statusDiv = document.getElementById('status');

    // File â†’ DataURL
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload  = () => resolve(reader.result);
        reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
        reader.readAsDataURL(file);
      });
    }

    // DataURL â†’ Base64 (ì´ë¯¸ì§€ ì••ì¶• ë¡œì§ì´ í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬)
    async function processAndCompressImage(dataUrl) {
      // ì˜ˆ: Canvasë¡œ ë¦¬ì‚¬ì´ì¦ˆÂ·ì••ì¶• ê°€ëŠ¥
      // ì§€ê¸ˆì€ ê·¸ëƒ¥ Base64 ë¶€ë¶„ë§Œ ë¦¬í„´
      return dataUrl.split(',')[1];
    }

    // GitHubì— íŒŒì¼ PUT
    async function updateGitHubFile(b64, targetPath) {
      const owner = localStorage.getItem(LS_KEYS.OWNER);
      const repo  = localStorage.getItem(LS_KEYS.NAME);
      const token = localStorage.getItem(LS_KEYS.GITHUB);
      const path  = targetPath || 'menu.jpg';

      // 1) SHA ì¡°íšŒ
      const getRes = await fetch(
        `https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
        headers: { Authorization: `token ${token}` }
      });
      if (!getRes.ok) throw new Error('GitHub GET ì‹¤íŒ¨: ' + getRes.status);
      const { sha } = await getRes.json();

      // 2) PUT ìš”ì²­
      const putRes = await fetch(
        `https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type':  'application/json'
        },
        body: JSON.stringify({
          message: "Update default menu image via admin UI",
          content: b64,
          sha: sha
        })
      });
      if (!putRes.ok) {
        const err = await putRes.json();
        throw new Error('GitHub PUT ì‹¤íŒ¨: ' + JSON.stringify(err));
      }
      return putRes.json();
    }

    uploadBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) {
        statusDiv.textContent = 'âš ï¸ ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
        return;
      }
      statusDiv.textContent = 'ğŸ“– íŒŒì¼ ì½ëŠ” ì¤‘â€¦';

      try {
        const dataUrl = await readFileAsDataURL(file);
        const b64     = await processAndCompressImage(dataUrl);

        statusDiv.textContent = 'ğŸ”„ GitHubì— ë°˜ì˜ ì¤‘â€¦';
        const target = pathIn.value.trim() || 'menu.jpg';
        await updateGitHubFile(b64, target);

        const rawUrl = `https://raw.githubusercontent.com/`
                     + `${ownerIn.value}/${nameIn.value}/main/`
                     + `${encodeURIComponent(target)}`;
        statusDiv.innerHTML = `âœ… ì™„ë£Œ!<br>
          <a href="${rawUrl}" target="_blank">ìƒˆ ì´ë¯¸ì§€ í™•ì¸</a><br>
          <small>ì ì‹œ í›„ index.htmlì— ë°˜ì˜ë©ë‹ˆë‹¤.</small>`;
      } catch (e) {
        statusDiv.textContent = 'âŒ ì˜¤ë¥˜: ' + e.message;
        console.error(e);
      }
    });
  </script>
</body>
</html>
